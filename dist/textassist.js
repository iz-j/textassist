/*!
 * Text Assist
 * 
 * version: 0.1
 * Copyright (c) 2015 iz-j
 */
var TextAssist=function(e,t){function n(){k=document.createElement("div"),L=document.createElement("ul"),L.tabIndex=-1,L.style.display="none",h(L,W),T.ulClassName?L.className=T.ulClassName:h(L,j),k.appendChild(L),w=document.createElement("div"),h(w,A),k.appendChild(w),document.body.appendChild(k)}function a(e){switch(e.keyCode){case 8:m()&&(S?i():C());break;case 9:break;case 13:E?(e.preventDefault(),v()):C();break;case 27:C();break;case 32:e.ctrlKey?(e.preventDefault(),m()?C():i()):C();break;case 38:E&&(e.preventDefault(),u());break;case 40:E&&(e.preventDefault(),d());break;case 37:case 39:m()&&i();break;case 33:case 34:case 35:case 36:C();break;default:m()&&i()}}function l(e){e.relatedTarget!==L&&C()}function o(e){for(var t=e.target;t&&t!==L;){if("A"===e.target.tagName&&t.dataset.value){H=t,v();break}t=t.parentNode}}function i(){M&&clearTimeout(M),M=setTimeout(r,T.delayMills)}function r(){for(E=!1,H=null;L.lastChild;)L.removeChild(L.lastChild);var e=document.createElement("li");e.innerHTML=T.loadingHTML,L.appendChild(e);var t=g();L.style.left=t.left+"px",L.style.top=t.top+"px",L.style.display="block",s(),T.find(S,c)}function s(){var e=x.value.slice(0,x.selectionStart),t=e.match(D);S=t?t[2]:""}function c(e){return e&&0!==e.length?(L.removeChild(L.firstChild),e.forEach(function(e){var t=document.createElement("li"),n=document.createElement("a");t.appendChild(n),T.liClassName&&(t.className=T.liClassName),T.anchorClassName?n.className=T.anchorClassName:h(n,q),n.dataset.value=e,n.innerHTML=T.item(e,S),L.appendChild(t),H||(f(n),L.scrollTop=0)}),void(E=!0)):void(L.firstChild.innerHTML=T.noneHTML)}function d(){H.parentNode.nextSibling&&f(H.parentNode.nextSibling.firstChild)}function u(){H.parentNode.previousSibling&&f(H.parentNode.previousSibling.firstChild)}function f(e){T.anchorClassName||(H&&h(H,q),h(e,R)),T.activeClassName&&(H&&H.parentNode.classList.remove(T.activeClassName),e.parentNode.classList.add(T.activeClassName)),H=e,p()}function p(){var e=L.scrollTop,t=L.offsetHeight+L.scrollTop-H.parentNode.offsetHeight;H.offsetTop<e?L.scrollTop=H.offsetTop:H.offsetTop>t&&(L.scrollTop=L.scrollTop+(H.offsetTop-t))}function v(){var e=H.dataset.value,t=x.value.slice(0,x.selectionStart),n=x.value.slice(x.selectionStart,x.value.length);t=t.replace(new RegExp(S+"$"),e),x.value=t+n,x.focus(),x.selectionStart=t.length,x.selectionEnd=t.length,C()}function h(e,t){Object.keys(t).forEach(function(n){e.style[n]=t[n]})}function m(){return"none"!==L.style.display}function g(){var e=document.defaultView.getComputedStyle(x,"");B.forEach(function(t){w.style[t]=e[t]}),w.style.overflow="auto";var t=x.value,n=t.slice(0,x.selectionStart),a=t.slice(x.selectionStart,x.selectionEnd),l=t.slice(x.selectionEnd,t.length);a||(a="|"),w.innerHTML=b(n)+'<span class="textassist-caret">'+b(a)+"</span>"+b(l),w.scrollLeft=x.scrollLeft,w.scrollTop=x.scrollTop;var o=w.querySelector(".textassist-caret"),i=y(x),r=y(w),s=y(o);return{left:i.left+(s.left-r.left),top:i.top+(s.top-r.top+o.offsetHeight)}}function b(e){return e.replace(/[&"<>]/g,function(e){return O[e]}).replace(/\r?\n/g,"<br />")}function y(e){var t=0,n=0;do t+=e.offsetTop||0,n+=e.offsetLeft||0,e=e.offsetParent;while(e);return{top:t,left:n}}function C(){L.style.display="none",E=!1}function N(){x.removeEventListener("keydown",a),x.removeEventListener("blur",l),L.removeEventListener("click",o),x=null,T=null,k.remove(),k=null,L=null,w=null,H=null}var T={find:function(e,t){throw'"find" function is required!'},ulClassName:null,liClassName:null,anchorClassName:null,activeClassName:null,item:function(e,t){return e},loadingHTML:'<a href="javasript:void(0)">Loading...</a>',noneHTML:'<a href="javasript:void(0)">No items...</a>',delayMills:200};Object.keys(T).forEach(function(e){e in t&&(T[e]=t[e])});var x=e,k=null,L=null,w=null,E=!1,S=null,H=null,M=null,D=/(^|\s)([^\s]*)$/,W={position:"absolute",overflowX:"hidden",overflowY:"auto"},j={"list-style":"none",border:"solid 1px silver",background:"white",boxShadow:"0px 3px 6px gray",padding:"4px",margin:"2px",maxHeight:"120px"},q={whiteSpace:"nowrap",cursor:"default",display:"block",padding:"2px 20px 2px 4px",background:"white",color:"black"},R={background:"gray",color:"white"},A={visibility:"hidden",position:"absolute",left:"0px",top:"0px",whiteSpace:"nowrap"};x.wrap="off",n(),x.addEventListener("keydown",a),x.addEventListener("blur",l),L.addEventListener("click",o);var B=["width","height","borderBottomWidth","borderLeftWidth","borderRightWidth","borderTopWidth","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","letterSpacing","wordSpacing","lineHeight","textDecoration","paddingBottom","paddingLeft","paddingRight","paddingTop"],O={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};return{hide:C,destroy:N}};