/*!
 * Text Assist
 * 
 * Copyright (c) 2015 iz-j
 */
var TextAssist=function(e,t){function n(){T=document.createElement("div"),C=document.createElement("ul"),C.style.display="none",u(C,N),u(C,D),T.appendChild(C),w=document.createElement("div"),u(w,R),T.appendChild(w),document.body.appendChild(T)}function o(e){switch(e.keyCode){case 13:S?(e.preventDefault(),p()):m();break;case 32:e.ctrlKey?(e.preventDefault(),f()?m():l()):m();break;case 38:S&&(e.preventDefault(),s());break;case 40:S&&(e.preventDefault(),c());break;case 37:case 39:f()&&l();break;case 33:case 34:case 35:case 36:m();break;default:f()&&l()}}function l(){E&&clearTimeout(E),E=setTimeout(i,100)}function i(){for(S=!1,k=null;C.lastChild;)C.removeChild(C.lastChild);var e=document.createElement("li");e.textContent="Loading...",C.appendChild(e);var t=h();C.style.left=t.left+"px",C.style.top=t.top+"px",C.style.display="block",x.search(r(),a)}function r(){var e=y.value.slice(0,y.selectionStart),t=e.match(L);return t?t[2]:""}function a(e){return e&&0!==e.length?(C.removeChild(C.firstChild),e.forEach(function(e){var t=document.createElement("li"),n=document.createElement("a");t.appendChild(n),u(n,W),n.textContent=e,n.dataset.value=e,C.appendChild(t),k||(k=n,u(k,H),C.scrollTop=0)}),void(S=!0)):void(C.firstChild.textContent="No items...")}function c(){k.parentNode.nextSibling&&(u(k,W),k=k.parentNode.nextSibling.firstChild,u(k,H),d())}function s(){k.parentNode.previousSibling&&(u(k,W),k=k.parentNode.previousSibling.firstChild,u(k,H),d())}function d(){var e=C.scrollTop,t=C.offsetHeight+C.scrollTop-k.parentNode.offsetHeight;k.offsetTop<e?C.scrollTop=k.offsetTop:k.offsetTop>t&&(C.scrollTop=C.scrollTop+(k.offsetTop-t))}function p(){var e=k.dataset.value,t=r(),n=y.value.slice(0,y.selectionStart),o=y.value.slice(y.selectionStart,y.value.length);n=n.replace(new RegExp(t+"$"),e),y.value=n+o,y.selectionStart=n.length,y.selectionEnd=n.length,m()}function u(e,t){Object.keys(t).forEach(function(n){e.style[n]=t[n]})}function f(){return"none"!==C.style.display}function h(){var e=document.defaultView.getComputedStyle(y,"");B.forEach(function(t){w.style[t]=e[t]}),w.style.overflow="auto";var t=y.value,n=t.slice(0,y.selectionStart),o=t.slice(y.selectionStart,y.selectionEnd),l=t.slice(y.selectionEnd,t.length);o||(o="|"),w.innerHTML=v(n)+'<span class="textassist-caret">'+v(o)+"</span>"+v(l),w.scrollLeft=y.scrollLeft,w.scrollTop=y.scrollTop;var i=g(y),r=g(w),a=g(w.querySelector(".textassist-caret"));return{left:i.left+(a.left-r.left),top:i.top+(a.top-r.top)}}function v(e){return e.replace(/[&"<>]/g,function(e){return q[e]}).replace(/\r?\n/g,"<br />")}function g(e){var t=document.documentElement,n=document.body,o=n.scrollLeft||t.scrollLeft,l=n.scrollTop||t.scrollTop,i=e.getBoundingClientRect(),r=i.left-t.clientLeft+o,a=i.top-t.clientTop+l;return{left:parseInt(r),top:parseInt(a)}}function m(){C.style.display="none",S=!1}function b(){y.removeEventListener("keydown",o),y=null,x=null,T.remove(),T=null,C=null,w=null,k=null}var y=e,x=t,T=null,C=null,w=null,S=!1,k=null,E=null,L=/(^|\s)([^\s]*)$/,N={position:"absolute",overflowX:"hidden",overflowY:"auto"},D={"list-style":"none",border:"solid 1px silver",background:"white",boxShadow:"0px 3px 6px gray",padding:"4px",height:"80px"},W={whiteSpace:"nowrap",cursor:"default",display:"block",clear:"both",padding:"2px 20px 2px 4px",background:"white",color:"black"},H={background:"gray",color:"white"},R={visibility:"hidden",position:"absolute",left:"0px",top:"0px",whiteSpace:"nowrap"};y.wrap="off",n(),y.addEventListener("keydown",o);var B=["width","height","borderBottomWidth","borderLeftWidth","borderRightWidth","borderTopWidth","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","letterSpacing","wordSpacing","lineHeight","textDecoration","paddingBottom","paddingLeft","paddingRight","paddingTop"],q={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};return{destroy:b}};